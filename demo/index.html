<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Refrakt Demo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
      :root {
        --bg-1: #0b1022;
        --bg-2: #14274e;
        --bg-3: #1f4a72;
        --ink: #edf4ff;
        --ink-dim: #a8bddb;
        --glass: rgba(255, 255, 255, 0.09);
        --glass-strong: rgba(255, 255, 255, 0.15);
        --edge: rgba(255, 255, 255, 0.22);
        --accent: #7ce2ff;
        --danger: #ff95ad;
      }

      * { box-sizing: border-box; }
      html, body { margin: 0; min-height: 100%; }

      body {
        font-family: "Sora", "Segoe UI", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(66rem 38rem at -8% 4%, #345fac 0%, transparent 62%),
          radial-gradient(52rem 36rem at 100% 94%, #2678b8 0%, transparent 58%),
          linear-gradient(145deg, var(--bg-1), var(--bg-2) 45%, var(--bg-3));
        padding: clamp(16px, 2vw, 26px);
      }

      .shell {
        max-width: 1240px;
        margin: 0 auto;
      }

      .glass {
        border: 1px solid var(--edge);
        border-radius: 18px;
        background: linear-gradient(160deg, var(--glass-strong), rgba(255,255,255,0.03));
        box-shadow: 0 18px 44px rgba(2, 8, 26, 0.5);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
      }

      .hero {
        padding: 18px 20px;
        margin-bottom: 14px;
      }

      h1 {
        margin: 0 0 6px;
        font-size: clamp(30px, 5vw, 44px);
        line-height: 1.05;
      }

      .hero p {
        margin: 0;
        color: var(--ink-dim);
      }

      .controls {
        display: flex;
        gap: 10px;
        padding: 14px;
        margin-bottom: 14px;
      }

      input {
        flex: 1;
        border: 1px solid var(--edge);
        border-radius: 12px;
        background: rgba(8, 18, 40, 0.65);
        color: var(--ink);
        font: 500 14px "JetBrains Mono", "Cascadia Code", monospace;
        padding: 11px 13px;
      }

      button {
        border: 1px solid rgba(124, 226, 255, 0.7);
        border-radius: 12px;
        color: #00131d;
        background: linear-gradient(145deg, #90f1ff, #68d8ff);
        font: 700 13px "Sora", sans-serif;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        padding: 10px 16px;
        cursor: pointer;
      }

      .panel {
        margin-bottom: 14px;
        padding: 15px;
      }

      .error-code {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
        border: 1px solid var(--edge);
        border-radius: 999px;
        padding: 7px 12px;
        background: rgba(255, 255, 255, 0.08);
        color: var(--ink-dim);
        font: 700 12px "JetBrains Mono", "Cascadia Code", monospace;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .error-code span {
        color: var(--danger);
      }

      .diag-grid {
        display: grid;
        grid-template-columns: 1.35fr 1fr;
        gap: 12px;
      }

      .diag-grid h2 {
        margin: 0 0 8px;
        font-size: 12px;
        letter-spacing: 0.09em;
        text-transform: uppercase;
        color: var(--ink-dim);
      }

      pre {
        margin: 0;
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 12px;
        background: rgba(2, 10, 30, 0.72);
        color: #d7eeff;
        padding: 12px;
        font: 12px/1.45 "JetBrains Mono", "Cascadia Code", monospace;
        white-space: pre-wrap;
        word-break: break-word;
      }

      .tips {
        margin: 0;
        padding-left: 20px;
      }

      .tips li {
        color: var(--ink-dim);
        margin: 7px 0;
      }

      iframe {
        width: 100%;
        height: 58vh;
        border: 1px solid var(--edge);
        border-radius: 16px;
        background: rgba(3, 8, 24, 0.42);
      }

      @media (max-width: 920px) {
        .controls { flex-direction: column; }
        .diag-grid { grid-template-columns: 1fr; }
        button { width: 100%; }
        iframe { height: 54vh; }
      }
    </style>
  </head>
  <body>
    <main class="shell">
      <section class="hero glass">
        <h1>Refrakt</h1>
        <p>Browser-side proxy demo with worker interception and AST rewrite pipeline.</p>
      </section>

      <section class="controls glass">
        <input id="url" value="https://example.com" />
        <button id="go">Navigate</button>
      </section>

      <section class="panel glass">
        <div class="error-code">Error Code <span id="errorCode">RFK-DEMO-0001</span></div>
        <div class="diag-grid">
          <div>
            <h2>Request Block</h2>
            <pre id="requestBlock"></pre>
          </div>
          <div>
            <h2>Tips</h2>
            <ol class="tips" id="tipsBlock"></ol>
          </div>
        </div>
      </section>

      <iframe id="frame"></iframe>
    </main>

    <script src="/dist/webrascal.controller.js"></script>
    <script>
      (async () => {
        if ("serviceWorker" in navigator) {
          const registration = await navigator.serviceWorker.register("/webrascal.worker.js", { scope: "/" });
          await navigator.serviceWorker.ready;
          if (!navigator.serviceWorker.controller) {
            location.reload();
            return;
          }
          void registration;
        }

        const { WebrascalController } = self.$webrascalLoadController();
        const controller = new WebrascalController({ prefix: "/webrascal/" });
        await controller.init();

        const iframe = document.getElementById("frame");
        const frame = controller.createFrame(iframe);
        const input = document.getElementById("url");
        const errorCode = document.getElementById("errorCode");
        const requestBlock = document.getElementById("requestBlock");
        const tipsBlock = document.getElementById("tipsBlock");

        function paintDiagnostics(url) {
          errorCode.textContent = "RFK-DEMO-0001";
          requestBlock.textContent = JSON.stringify({
            action: "frame.go",
            inputUrl: url,
            encodedUrl: controller.encodeUrl(url),
            workerScope: "/",
            proxyPrefix: controller.config.prefix
          }, null, 2);

          tipsBlock.innerHTML = "";
          [
            "If navigation fails, open the proxied URL directly in a new tab to inspect the detailed worker error page.",
            "Keep the service worker registered at /webrascal.worker.js so scope remains '/'.",
            "Use the diagnostics payload and error code to trace worker pipeline failures quickly."
          ].forEach((tip) => {
            const li = document.createElement("li");
            li.textContent = tip;
            tipsBlock.appendChild(li);
          });
        }

        document.getElementById("go").addEventListener("click", () => {
          const target = input.value;
          paintDiagnostics(target);
          frame.go(target);
        });

        paintDiagnostics(input.value);
        frame.go(input.value);
      })();
    </script>
  </body>
</html>
